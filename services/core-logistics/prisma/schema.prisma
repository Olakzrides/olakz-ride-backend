// Prisma Schema for Core Logistics Service
// Phase 1: Core ride booking tables only

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/logistics-client"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Regions for currency and pricing
model Region {
  id           String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String     @db.VarChar(100)
  currencyCode String     @map("currency_code") @db.VarChar(3)
  countryCode  String     @map("country_code") @db.VarChar(2)
  isActive     Boolean    @default(true) @map("is_active")
  metadata     Json       @default("{}")
  createdAt    DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  rideCarts    RideCart[]

  @@index([isActive])
  @@index([countryCode])
  @@map("regions")
}

// Service types (ride, delivery)
model ServiceType {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String   @unique @db.VarChar(50) // 'ride', 'delivery'
  displayName String   @map("display_name") @db.VarChar(100)
  description String?  @db.Text
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  vehicleServiceCapabilities VehicleServiceCapability[]

  @@index([isActive])
  @@map("service_types")
}

// Vehicle-Service capability mapping
model VehicleServiceCapability {
  id            String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  vehicleTypeId String      @map("vehicle_type_id") @db.Uuid
  serviceTypeId String      @map("service_type_id") @db.Uuid
  isAvailable   Boolean     @default(true) @map("is_available")
  createdAt     DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  vehicleType   VehicleType @relation(fields: [vehicleTypeId], references: [id], onDelete: Cascade)
  serviceType   ServiceType @relation(fields: [serviceTypeId], references: [id], onDelete: Cascade)

  @@unique([vehicleTypeId, serviceTypeId])
  @@index([vehicleTypeId])
  @@index([serviceTypeId])
  @@map("vehicle_service_capabilities")
}

// Vehicle types (Standard, Premium, VIP) - Enhanced with requirements
model VehicleType {
  id               String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name             String        @db.VarChar(50)
  displayName      String        @map("display_name") @db.VarChar(100)
  description      String?       @db.Text
  baseFarePerKm    Decimal       @map("base_fare_per_km") @db.Decimal(10, 2)
  baseFarePerMinute Decimal      @default(0) @map("base_fare_per_minute") @db.Decimal(10, 2)
  minimumFare      Decimal       @map("minimum_fare") @db.Decimal(10, 2)
  capacity         Int           @default(4)
  iconUrl          String?       @map("icon_url") @db.Text
  isActive         Boolean       @default(true) @map("is_active")
  
  // Requirements matrix
  licenseRequired     Boolean @default(true) @map("license_required")
  insuranceRequired   Boolean @default(true) @map("insurance_required")
  registrationRequired Boolean @default(true) @map("registration_required")
  
  metadata         Json          @default("{}")
  createdAt        DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  rideVariants     RideVariant[]
  driversVehicleType Driver[]    @relation("DriverVehicleType") // DEPRECATED: Physical vehicle type
  driversServiceTier Driver[]    @relation("DriverServiceTier") // Service tier (Standard/Premium/VIP)
  driverVehicles   DriverVehicle[]
  serviceCapabilities VehicleServiceCapability[]

  @@index([isActive])
  @@index([name])
  @@map("vehicle_types")
}

// Ride products (service offerings)
model RideProduct {
  id           String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title        String        @db.VarChar(100)
  handle       String        @unique @db.VarChar(100)
  description  String?       @db.Text
  thumbnailUrl String?       @map("thumbnail_url") @db.Text
  isActive     Boolean       @default(true) @map("is_active")
  metadata     Json          @default("{}")
  createdAt    DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  rideVariants RideVariant[]

  @@index([handle])
  @@index([isActive])
  @@map("ride_products")
}

// Ride variants (pricing tiers within products)
model RideVariant {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId      String       @map("product_id") @db.Uuid
  vehicleTypeId  String       @map("vehicle_type_id") @db.Uuid
  title          String       @db.VarChar(50)
  sku            String       @unique @db.VarChar(50)
  basePrice      Decimal      @map("base_price") @db.Decimal(10, 2)
  pricePerKm     Decimal      @map("price_per_km") @db.Decimal(10, 2)
  pricePerMinute Decimal      @default(0) @map("price_per_minute") @db.Decimal(10, 2)
  minimumFare    Decimal      @map("minimum_fare") @db.Decimal(10, 2)
  isActive       Boolean      @default(true) @map("is_active")
  metadata       Json         @default("{}")
  createdAt      DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  product        RideProduct  @relation(fields: [productId], references: [id], onDelete: Cascade)
  vehicleType    VehicleType  @relation(fields: [vehicleTypeId], references: [id])
  cartLineItems  CartLineItem[]
  rides          Ride[]

  @@index([productId])
  @@index([vehicleTypeId])
  @@index([isActive])
  @@index([sku])
  @@map("ride_variants")
}

// Shopping carts for ride booking
model RideCart {
  id               String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId           String         @map("user_id") @db.Uuid
  regionId         String         @map("region_id") @db.Uuid
  salesChannelId   String         @map("sales_channel_id") @db.Uuid
  currencyCode     String         @map("currency_code") @db.VarChar(3)
  pickupLatitude   Decimal        @map("pickup_latitude") @db.Decimal(10, 8)
  pickupLongitude  Decimal        @map("pickup_longitude") @db.Decimal(11, 8)
  pickupAddress    String         @map("pickup_address") @db.Text
  dropoffLatitude  Decimal?       @map("dropoff_latitude") @db.Decimal(10, 8)
  dropoffLongitude Decimal?       @map("dropoff_longitude") @db.Decimal(11, 8)
  dropoffAddress   String?        @map("dropoff_address") @db.Text
  passengers       Int            @default(1)
  searchRadius     Int            @default(10) @map("search_radius")
  status           String         @default("active") @db.VarChar(20)
  metadata         Json           @default("{}")
  createdAt        DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime       @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  region           Region         @relation(fields: [regionId], references: [id])
  cartLineItems    CartLineItem[]
  rides            Ride[]
  stops            RideStop[]     @relation("CartStops")

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("ride_carts")
}

// Cart line items (selected variants)
model CartLineItem {
  id         String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  cartId     String      @map("cart_id") @db.Uuid
  variantId  String      @map("variant_id") @db.Uuid
  quantity   Int         @default(1)
  unitPrice  Decimal     @map("unit_price") @db.Decimal(10, 2)
  totalPrice Decimal     @map("total_price") @db.Decimal(10, 2)
  createdAt  DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  cart       RideCart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  variant    RideVariant @relation(fields: [variantId], references: [id])

  @@unique([cartId, variantId])
  @@index([cartId])
  @@index([variantId])
  @@map("cart_line_items")
}

// Actual rides (after booking confirmation)
model Ride {
  id                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  cartId              String?   @map("cart_id") @db.Uuid
  userId              String    @map("user_id") @db.Uuid
  driverId            String?   @map("driver_id") @db.Uuid
  variantId           String    @map("variant_id") @db.Uuid
  status              String    @default("searching") @db.VarChar(30)
  
  // Booking type and recipient details (for "Book for Someone Else" feature)
  bookingType         String    @default("for_me") @map("booking_type") @db.VarChar(20) // 'for_me' or 'for_friend'
  recipientName       String?   @map("recipient_name") @db.VarChar(100)
  recipientPhone      String?   @map("recipient_phone") @db.VarChar(20)
  
  pickupLatitude      Decimal   @map("pickup_latitude") @db.Decimal(10, 8)
  pickupLongitude     Decimal   @map("pickup_longitude") @db.Decimal(11, 8)
  pickupAddress       String    @map("pickup_address") @db.Text
  dropoffLatitude     Decimal?  @map("dropoff_latitude") @db.Decimal(10, 8)
  dropoffLongitude    Decimal?  @map("dropoff_longitude") @db.Decimal(11, 8)
  dropoffAddress      String?   @map("dropoff_address") @db.Text
  estimatedDistance   Decimal?  @map("estimated_distance") @db.Decimal(8, 2)
  estimatedDuration   Int?      @map("estimated_duration")
  actualDistance      Decimal?  @map("actual_distance") @db.Decimal(8, 2)
  actualDuration      Int?      @map("actual_duration")
  estimatedFare       Decimal   @map("estimated_fare") @db.Decimal(10, 2)
  finalFare           Decimal?  @map("final_fare") @db.Decimal(10, 2)
  paymentMethod       String    @default("wallet") @map("payment_method") @db.VarChar(20)
  paymentStatus       String    @default("pending") @map("payment_status") @db.VarChar(20)
  scheduledAt         DateTime? @map("scheduled_at") @db.Timestamptz(6)
  startedAt           DateTime? @map("started_at") @db.Timestamptz(6)
  completedAt         DateTime? @map("completed_at") @db.Timestamptz(6)
  cancelledAt         DateTime? @map("cancelled_at") @db.Timestamptz(6)
  cancellationReason  String?   @map("cancellation_reason") @db.Text
  driverRating        Int?      @map("driver_rating")
  driverFeedback      String?   @map("driver_feedback") @db.Text
  passengerRating     Int?      @map("passenger_rating")
  passengerFeedback   String?   @map("passenger_feedback") @db.Text
  
  // Ride sharing fields
  shareToken          String?   @unique @map("share_token") @db.VarChar(255)
  shareTokenCreatedAt DateTime? @map("share_token_created_at") @db.Timestamptz(6)
  shareTokenExpiresAt DateTime? @map("share_token_expires_at") @db.Timestamptz(6)
  shareTokenRevoked   Boolean   @default(false) @map("share_token_revoked")
  
  metadata            Json      @default("{}")
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  cart                RideCart?           @relation(fields: [cartId], references: [id])
  variant             RideVariant         @relation(fields: [variantId], references: [id])
  driver              Driver?             @relation("DriverRides", fields: [driverId], references: [id])
  walletTransactions  WalletTransaction[]
  rideRequests        RideRequest[]
  statusUpdates       RideStatusUpdate[]  @relation("RideStatusUpdates")
  stops               RideStop[]          @relation("RideStops")

  @@index([userId])
  @@index([driverId])
  @@index([status])
  @@index([bookingType])
  @@index([shareToken])
  @@index([createdAt])
  @@index([status, createdAt])
  @@map("rides")
}

// Wallet transactions for ride payments
model WalletTransaction {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  rideId          String?  @map("ride_id") @db.Uuid
  transactionType String   @map("transaction_type") @db.VarChar(20)
  amount          Decimal  @db.Decimal(10, 2)
  currencyCode    String   @map("currency_code") @db.VarChar(3)
  status          String   @default("pending") @db.VarChar(20)
  reference       String?  @unique @db.VarChar(100)
  description     String?  @db.Text
  metadata        Json     @default("{}")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  ride            Ride?    @relation(fields: [rideId], references: [id])

  @@index([userId])
  @@index([rideId])
  @@index([transactionType])
  @@index([status])
  @@index([reference])
  @@index([userId, transactionType, status])
  @@map("wallet_transactions")
}

// Ride stops for multiple waypoints feature
model RideStop {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  rideId          String?   @map("ride_id") @db.Uuid
  cartId          String?   @map("cart_id") @db.Uuid
  stopOrder       Int       @map("stop_order")
  stopType        String    @map("stop_type") @db.VarChar(20) // 'pickup', 'waypoint', 'dropoff'
  latitude        Decimal   @db.Decimal(10, 8)
  longitude       Decimal   @db.Decimal(11, 8)
  address         String    @db.Text
  arrivalTime     DateTime? @map("arrival_time") @db.Timestamptz(6)
  departureTime   DateTime? @map("departure_time") @db.Timestamptz(6)
  waitTimeMinutes Int       @default(0) @map("wait_time_minutes")
  notes           String?   @db.Text
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  ride            Ride?     @relation("RideStops", fields: [rideId], references: [id], onDelete: Cascade)
  cart            RideCart? @relation("CartStops", fields: [cartId], references: [id], onDelete: Cascade)

  @@index([rideId])
  @@index([cartId])
  @@index([rideId, stopOrder])
  @@index([stopType])
  @@map("ride_stops")
}

// ============================================
// PHASE 3: REAL-TIME FEATURES
// ============================================

// Ride requests sent to multiple drivers
model RideRequest {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  rideId          String    @map("ride_id") @db.Uuid
  driverId        String    @map("driver_id") @db.Uuid
  status          String    @default("pending") @db.VarChar(20) // pending, accepted, declined, expired, cancelled
  sentAt          DateTime  @default(now()) @map("sent_at") @db.Timestamptz(6)
  respondedAt     DateTime? @map("responded_at") @db.Timestamptz(6)
  expiresAt       DateTime  @map("expires_at") @db.Timestamptz(6)
  batchNumber     Int       @default(1) @map("batch_number") // For tracking multiple batches
  distanceFromPickup Decimal @map("distance_from_pickup") @db.Decimal(8, 2) // km
  estimatedArrival   Int     @map("estimated_arrival") // minutes
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  ride            Ride      @relation(fields: [rideId], references: [id], onDelete: Cascade)
  driver          Driver    @relation("DriverRideRequests", fields: [driverId], references: [id])

  @@unique([rideId, driverId])
  @@index([rideId])
  @@index([driverId])
  @@index([status])
  @@index([expiresAt])
  @@index([batchNumber])
  @@index([rideId, status])
  @@index([driverId, status])
  @@map("ride_requests")
}

// Real-time driver location tracking (optimized for frequent updates)
model DriverLocationTracking {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  driverId        String   @map("driver_id") @db.Uuid
  latitude        Decimal  @db.Decimal(10, 8)
  longitude       Decimal  @db.Decimal(11, 8)
  heading         Decimal? @db.Decimal(5, 2) // Direction in degrees (0-360)
  speed           Decimal? @db.Decimal(5, 2) // Speed in km/h
  accuracy        Decimal? @db.Decimal(6, 2) // GPS accuracy in meters
  isOnline        Boolean  @default(true) @map("is_online")
  isAvailable     Boolean  @default(true) @map("is_available")
  batteryLevel    Int?     @map("battery_level") // 0-100
  appVersion      String?  @map("app_version") @db.VarChar(20)
  deviceInfo      Json?    @map("device_info") @default("{}")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  driver          Driver   @relation("DriverLocationTracking", fields: [driverId], references: [id], onDelete: Cascade)

  @@index([driverId])
  @@index([createdAt])
  @@index([isOnline, isAvailable])
  @@index([driverId, createdAt])
  @@map("driver_location_tracking")
}

// Real-time ride status updates and events
model RideStatusUpdate {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  rideId          String   @map("ride_id") @db.Uuid
  status          String   @db.VarChar(30) // searching, driver_assigned, driver_arriving, driver_arrived, in_progress, completed, cancelled
  previousStatus  String?  @map("previous_status") @db.VarChar(30)
  updatedBy       String   @map("updated_by") @db.Uuid // user_id or driver_id
  updatedByType   String   @map("updated_by_type") @db.VarChar(20) // customer, driver, system
  message         String?  @db.Text // Optional status message
  location        Json?    @default("{}") // Current location when status changed
  metadata        Json     @default("{}")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  ride            Ride     @relation("RideStatusUpdates", fields: [rideId], references: [id], onDelete: Cascade)

  @@index([rideId])
  @@index([status])
  @@index([createdAt])
  @@index([rideId, createdAt])
  @@map("ride_status_updates")
}

// Socket.IO connection tracking for real-time features
model SocketConnection {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  socketId        String   @unique @map("socket_id") @db.VarChar(100)
  userId          String   @map("user_id") @db.Uuid
  userType        String   @map("user_type") @db.VarChar(20) // customer, driver, admin
  isConnected     Boolean  @default(true) @map("is_connected")
  lastActivity    DateTime @default(now()) @map("last_activity") @db.Timestamptz(6)
  deviceInfo      Json?    @map("device_info") @default("{}")
  appVersion      String?  @map("app_version") @db.VarChar(20)
  connectedAt     DateTime @default(now()) @map("connected_at") @db.Timestamptz(6)
  disconnectedAt  DateTime? @map("disconnected_at") @db.Timestamptz(6)

  @@index([userId])
  @@index([userType])
  @@index([isConnected])
  @@index([lastActivity])
  @@index([userId, isConnected])
  @@map("socket_connections")
}
// ============================================
// PHASE 2: DRIVER MANAGEMENT
// ============================================

model Driver {
  id                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId              String    @unique @map("user_id") @db.Uuid
  identificationType  String    @map("identification_type") @db.VarChar(50) // drivers_license, national_id, passport
  identificationNumber String   @unique @map("identification_number") @db.VarChar(100)
  licenseNumber       String?   @map("license_number") @db.VarChar(100) // Optional for bicycle/e-scooter
  vehicleTypeId       String    @map("vehicle_type_id") @db.Uuid // DEPRECATED: Use serviceTierId for matching
  serviceTierId       String    @map("service_tier_id") @db.Uuid // Service tier: Standard/Premium/VIP
  status              String    @default("pending") @db.VarChar(50) // pending, approved, rejected, suspended, inactive
  rating              Decimal   @default(0) @db.Decimal(3, 2)
  totalRides          Int       @default(0) @map("total_rides")
  totalEarnings       Decimal   @default(0) @map("total_earnings") @db.Decimal(10, 2)
  approvedBy          String?   @map("approved_by") @db.Uuid
  approvedAt          DateTime? @map("approved_at") @db.Timestamptz(6)
  rejectionReason     String?   @map("rejection_reason") @db.Text
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  vehicleType       VehicleType          @relation("DriverVehicleType", fields: [vehicleTypeId], references: [id])
  serviceTier       VehicleType          @relation("DriverServiceTier", fields: [serviceTierId], references: [id])
  vehicles          DriverVehicle[]
  documents         DriverDocument[]
  availability      DriverAvailability?
  locationHistory   DriverLocation[]
  rides             Ride[]               @relation("DriverRides")
  rideRequests      RideRequest[]        @relation("DriverRideRequests")
  locationTracking  DriverLocationTracking[] @relation("DriverLocationTracking")

  @@index([userId])
  @@index([vehicleTypeId])
  @@index([serviceTierId])
  @@index([status])
  @@index([rating])
  @@index([createdAt])
  @@map("drivers")
}

model DriverVehicle {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  driverId      String   @map("driver_id") @db.Uuid
  vehicleTypeId String   @map("vehicle_type_id") @db.Uuid
  plateNumber   String   @unique @map("plate_number") @db.VarChar(50)
  manufacturer  String   @db.VarChar(100)
  model         String   @db.VarChar(100)
  year          Int
  color         String   @db.VarChar(50)
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  driver      Driver      @relation(fields: [driverId], references: [id], onDelete: Cascade)
  vehicleType VehicleType @relation(fields: [vehicleTypeId], references: [id])

  @@index([driverId])
  @@index([vehicleTypeId])
  @@index([isActive])
  @@map("driver_vehicles")
}

model DriverDocument {
  id                   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  driverId             String?   @map("driver_id") @db.Uuid
  sessionId            String?   @map("session_id") @db.Uuid
  documentType         String    @map("document_type") @db.VarChar(100) // license, insurance, vehicle_registration, profile_photo, vehicle_photo
  documentUrl          String    @map("document_url") @db.Text
  fileName             String    @map("file_name") @db.VarChar(255)
  fileSize             Int       @map("file_size")
  mimeType             String    @map("mime_type") @db.VarChar(100)
  status               String    @default("pending") @db.VarChar(50) // pending, approved, rejected
  verifiedBy           String?   @map("verified_by") @db.Uuid
  verifiedAt           DateTime? @map("verified_at") @db.Timestamptz(6)
  expiryDate           DateTime? @map("expiry_date") @db.Timestamptz(6)
  notes                String?   @db.Text
  
  // Phase 2B: Document Versioning & OCR
  versionNumber        Int       @default(1) @map("version_number")
  parentDocumentId     String?   @map("parent_document_id") @db.Uuid
  isCurrentVersion     Boolean   @default(true) @map("is_current_version")
  replacedAt           DateTime? @map("replaced_at") @db.Timestamptz(6)
  replacementReason    String?   @map("replacement_reason") @db.Text
  filePath             String?   @map("file_path") @db.Text
  ocrData              Json      @default("{}") @map("ocr_data") @db.JsonB
  extractedText        String?   @map("extracted_text") @db.Text
  expiryDateExtracted  DateTime? @map("expiry_date_extracted") @db.Date
  validationErrors     Json      @default("[]") @map("validation_errors") @db.JsonB
  
  createdAt            DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  driver               Driver?   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  session              DriverRegistrationSession? @relation(fields: [sessionId], references: [id])
  parentDocument       DriverDocument? @relation("DocumentVersions", fields: [parentDocumentId], references: [id])
  childDocuments       DriverDocument[] @relation("DocumentVersions")
  reviews              DocumentReview[]
  notifications        DocumentNotification[]
  accessLogs           DocumentAccessLog[]

  @@index([driverId])
  @@index([sessionId])
  @@index([documentType])
  @@index([status])
  @@index([driverId, documentType, versionNumber])
  @@index([driverId, documentType, isCurrentVersion])
  @@index([parentDocumentId])
  @@index([expiryDateExtracted])
  @@map("driver_documents")
}

model DriverAvailability {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  driverId    String   @unique @map("driver_id") @db.Uuid
  isOnline    Boolean  @default(false) @map("is_online")
  isAvailable Boolean  @default(false) @map("is_available")
  lastSeenAt  DateTime @default(now()) @map("last_seen_at") @db.Timestamptz(6)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  driver Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([isOnline])
  @@index([isAvailable])
  @@index([lastSeenAt])
  @@map("driver_availability")
}

model DriverLocation {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  driverId  String   @map("driver_id") @db.Uuid
  latitude  Decimal  @db.Decimal(10, 8)
  longitude Decimal  @db.Decimal(11, 8)
  heading   Decimal? @db.Decimal(5, 2) // Direction in degrees (0-360)
  speed     Decimal? @db.Decimal(5, 2) // Speed in km/h
  accuracy  Decimal? @db.Decimal(6, 2) // GPS accuracy in meters
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  driver Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([driverId])
  @@index([createdAt])
  @@map("driver_locations")
}

// ============================================
// PHASE 2: DRIVER REGISTRATION SESSIONS
// ============================================

// Multi-step driver registration sessions
model DriverRegistrationSession {
  id                         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId                     String    @map("user_id") @db.Uuid
  vehicleType                String    @map("vehicle_type") @db.VarChar(50)
  serviceTypes               String[]  @map("service_types")
  status                     String    @default("initiated") @db.VarChar(20)
  progressPercentage         Int       @default(0) @map("progress_percentage")
  currentStep                String    @default("personal_info") @map("current_step") @db.VarChar(30)
  expiresAt                  DateTime  @map("expires_at") @db.Timestamptz(6)
  createdAt                  DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                  DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Step completion tracking
  personalInfoCompletedAt    DateTime? @map("personal_info_completed_at") @db.Timestamptz(6)
  vehicleDetailsCompletedAt  DateTime? @map("vehicle_details_completed_at") @db.Timestamptz(6)
  documentsCompletedAt       DateTime? @map("documents_completed_at") @db.Timestamptz(6)
  submittedAt                DateTime? @map("submitted_at") @db.Timestamptz(6)

  // Step data (JSON for flexibility)
  personalInfoData           Json?     @map("personal_info_data") @db.JsonB
  vehicleDetailsData         Json?     @map("vehicle_details_data") @db.JsonB
  documentsData              Json?     @map("documents_data") @db.JsonB

  // Metadata
  metadata                   Json      @default("{}") @db.JsonB

  // Relations
  documents                  DriverDocument[]

  @@index([userId])
  @@index([status])
  @@index([expiresAt])
  @@index([createdAt])
  @@map("driver_registration_sessions")
}
// ============================================
// PHASE 2B: DOCUMENT VERIFICATION WORKFLOW
// ============================================

// Document reviews by admin users
model DocumentReview {
  id                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  documentId          String    @map("document_id") @db.Uuid
  reviewerId          String    @map("reviewer_id") @db.Uuid // Admin user ID
  action              String    @db.VarChar(20) // approve, reject, request_replacement
  status              String    @default("pending") @db.VarChar(20) // pending, completed, cancelled
  notes               String?   @db.Text
  rejectionReason     String?   @map("rejection_reason") @db.Text
  replacementRequested Boolean  @default(false) @map("replacement_requested")
  priority            String    @default("normal") @db.VarChar(10) // low, normal, high, urgent
  metadata            Json      @default("{}") @db.JsonB
  reviewedAt          DateTime? @map("reviewed_at") @db.Timestamptz(6)
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  document            DriverDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([reviewerId])
  @@index([status])
  @@index([action])
  @@index([priority])
  @@index([createdAt])
  @@map("document_reviews")
}

// Email notifications for document status changes
model DocumentNotification {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  documentId       String    @map("document_id") @db.Uuid
  userId           String    @map("user_id") @db.Uuid // Driver user ID
  notificationType String    @map("notification_type") @db.VarChar(30) // document_approved, document_rejected, replacement_requested, review_pending
  emailSent        Boolean   @default(false) @map("email_sent")
  emailSentAt      DateTime? @map("email_sent_at") @db.Timestamptz(6)
  emailError       String?   @map("email_error") @db.Text
  retryCount       Int       @default(0) @map("retry_count")
  metadata         Json      @default("{}") @db.JsonB
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  document         DriverDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([userId])
  @@index([notificationType])
  @@index([emailSent])
  @@index([createdAt])
  @@map("document_notifications")
}

// Document access logs for audit trail
model DocumentAccessLog {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  documentId String   @map("document_id") @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  action     String   @db.VarChar(20) // upload, view, download, delete, update
  ipAddress  String?  @map("ip_address") @db.VarChar(45)
  userAgent  String?  @map("user_agent") @db.Text
  metadata   Json     @default("{}") @db.JsonB
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  document   DriverDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([documentId, userId])
  @@map("document_access_logs")
}

// ============================================
// PHASE 2B: PUSH NOTIFICATIONS & REAL-TIME
// ============================================

// Device tokens for push notifications (FCM)
model DeviceToken {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  deviceId    String   @map("device_id") @db.VarChar(255)
  fcmToken    String   @map("fcm_token") @db.Text
  platform    String   @db.VarChar(20) // android, ios, web
  appVersion  String?  @map("app_version") @db.VarChar(50)
  deviceInfo  Json     @default("{}") @map("device_info") @db.JsonB
  isActive    Boolean  @default(true) @map("is_active")
  lastUsedAt  DateTime @default(now()) @map("last_used_at") @db.Timestamptz(6)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([userId, deviceId])
  @@index([userId])
  @@index([fcmToken])
  @@index([isActive])
  @@map("device_tokens")
}

// User notification preferences
model NotificationPreference {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String   @unique @map("user_id") @db.Uuid
  pushEnabled     Boolean  @default(true) @map("push_enabled")
  emailEnabled    Boolean  @default(true) @map("email_enabled")
  smsEnabled      Boolean  @default(false) @map("sms_enabled")
  rideUpdates     Boolean  @default(true) @map("ride_updates")
  promotional     Boolean  @default(true)
  driverMessages  Boolean  @default(true) @map("driver_messages")
  rideReminders   Boolean  @default(true) @map("ride_reminders")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("notification_preferences")
}

// Notification history for audit and tracking
model NotificationHistory {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId           String    @map("user_id") @db.Uuid
  rideId           String?   @map("ride_id") @db.Uuid
  notificationType String    @map("notification_type") @db.VarChar(50)
  channel          String    @db.VarChar(20) // push, email, sms, socket
  title            String?   @db.VarChar(255)
  body             String    @db.Text
  data             Json      @default("{}") @db.JsonB
  status           String    @default("sent") @db.VarChar(20) // sent, delivered, failed, read
  errorMessage     String?   @map("error_message") @db.Text
  sentAt           DateTime  @default(now()) @map("sent_at") @db.Timestamptz(6)
  deliveredAt      DateTime? @map("delivered_at") @db.Timestamptz(6)
  readAt           DateTime? @map("read_at") @db.Timestamptz(6)
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([userId])
  @@index([rideId])
  @@index([notificationType])
  @@index([channel])
  @@index([status])
  @@index([sentAt])
  @@map("notification_history")
}


// Saved places for users (home, work, favorites)
model SavedPlace {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  placeType   String   @map("place_type") @db.VarChar(20) // 'home', 'work', 'favorite'
  label       String?  @db.VarChar(100)
  latitude    Decimal  @db.Decimal(10, 8)
  longitude   Decimal  @db.Decimal(11, 8)
  address     String   @db.Text
  isDefault   Boolean  @default(false) @map("is_default")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([userId])
  @@index([userId, placeType])
  @@index([userId, isDefault])
  @@unique([userId, placeType, isDefault], name: "unique_default_place")
  @@map("saved_places")
}

// Recently visited locations (auto-populated from completed rides)
model RecentLocation {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String   @map("user_id") @db.Uuid
  locationType   String   @map("location_type") @db.VarChar(20) // 'pickup' or 'dropoff'
  latitude       Decimal  @db.Decimal(10, 8)
  longitude      Decimal  @db.Decimal(11, 8)
  address        String   @db.Text
  visitCount     Int      @default(1) @map("visit_count")
  lastVisitedAt  DateTime @map("last_visited_at") @db.Timestamptz(6)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([userId, lastVisitedAt(sort: Desc)])
  @@index([userId, locationType])
  @@unique([userId, address])
  @@map("recent_locations")
}


model payment_cards {
  id                 String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id            String   @db.Uuid
  card_token         String   @unique @db.VarChar(255)
  authorization_code String?  @db.VarChar(255)
  card_last4         String   @db.VarChar(4)
  card_brand         String   @db.VarChar(20)
  card_type          String?  @db.VarChar(20)
  card_exp_month     String   @db.VarChar(2)
  card_exp_year      String   @db.VarChar(4)
  cardholder_name    String?  @db.VarChar(100)
  bank_name          String?  @db.VarChar(100)
  country_code       String?  @db.VarChar(2)
  is_default         Boolean  @default(false)
  is_active          Boolean  @default(true)
  provider           String   @default("flutterwave") @db.VarChar(20)
  metadata           Json     @default("{}")
  created_at         DateTime @default(now()) @db.Timestamptz(6)
  updated_at         DateTime @default(now()) @db.Timestamptz(6)

  @@index([user_id])
  @@index([user_id, is_default])
  @@index([user_id, is_active])
}
